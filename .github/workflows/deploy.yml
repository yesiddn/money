name: Deploy Django Backend to Azure VM

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: PRD

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Build deploy archive
        run: |
          # Create a compressed archive from the committed HEAD and include a generated .env
          git rev-parse --verify HEAD
          tmpdir=$(mktemp -d)
          # export the repo files from HEAD into tmpdir
          git archive --format=tar HEAD | tar -x -C "$tmpdir"

          # helper to escape single quotes in secrets for safe single-quoted assignment
          escape() { printf "%s" "$1" | sed "s/'/'\"'\"'/g"; }

          # write .env into the temp dir with single-quoted values
          envfile="$tmpdir/.env"
          printf "POSTGRES_DB='%s'\n" "$(escape "${{ secrets.POSTGRES_DB }}")" > "$envfile"
          printf "POSTGRES_USER='%s'\n" "$(escape "${{ secrets.POSTGRES_USER }}")" >> "$envfile"
          printf "POSTGRES_PASSWORD='%s'\n" "$(escape "${{ secrets.POSTGRES_PASSWORD }}")" >> "$envfile"
          printf "POSTGRES_HOST='%s'\n" "$(escape "${{ secrets.POSTGRES_HOST }}")" >> "$envfile"
          printf "POSTGRES_PORT='%s'\n" "$(escape "${{ secrets.POSTGRES_PORT }}")" >> "$envfile"
          printf "DJANGO_SUPERUSER_EMAIL='%s'\n" "$(escape "${{ secrets.DJANGO_SUPERUSER_EMAIL }}")" >> "$envfile"
          printf "DJANGO_SUPERUSER_PASSWORD='%s'\n" "$(escape "${{ secrets.DJANGO_SUPERUSER_PASSWORD }}")" >> "$envfile"
          printf "DJANGO_SUPERUSER_USERNAME='%s'\n" "$(escape "${{ secrets.DJANGO_SUPERUSER_USERNAME }}")" >> "$envfile"
          printf "DJANGO_SECRET_KEY='%s'\n" "$(escape "${{ secrets.DJANGO_SECRET_KEY }}")" >> "$envfile"
          printf "DJANGO_DEBUG=False\n" >> "$envfile"
          printf "DJANGO_ALLOWED_HOSTS='%s'\n" "$(escape "${{ secrets.DJANGO_ALLOWED_HOSTS }}")" >> "$envfile"

          # create tar from tmpdir
          (cd "$tmpdir" && tar -czf /github/workspace/deploy.tar.gz .)
          rm -rf "$tmpdir"

      - name: Remote healthcheck & create target dir
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.AZURE_VM_HOST }}
          username: ${{ secrets.AZURE_VM_USERNAME }}
          key: ${{ secrets.AZURE_VM_SSH_PRIVATE_KEY }}
          port: 22
          script: |
            echo "remote user: $(whoami)"
            echo "remote HOME: $HOME"
            mkdir -p "$HOME/money"
            ls -ld "$HOME" "$HOME/money"

      - name: Upload archive to VM
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.AZURE_VM_HOST }}
          username: ${{ secrets.AZURE_VM_USERNAME }}
          key: ${{ secrets.AZURE_VM_SSH_PRIVATE_KEY }}
          port: 22
          source: 'deploy.tar.gz'
          target: '/tmp'
          debug: true

      - name: Extract archive and run deploy script on VM
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.AZURE_VM_HOST }}
          username: ${{ secrets.AZURE_VM_USERNAME }}
          key: ${{ secrets.AZURE_VM_SSH_PRIVATE_KEY }}
          port: 22
          script: |
            set -euo pipefail
            echo "Preparing deploy directory..."
            rm -rf "$HOME/money"
            mkdir -p "$HOME/money"
            echo "Extracting archive to $HOME/money"
            tar xzf /tmp/deploy.tar.gz -C "$HOME/money"
            rm -f /tmp/deploy.tar.gz

            cd "$HOME/money"
            chmod +x ./config_django_env.sh
            ./config_django_env.sh
