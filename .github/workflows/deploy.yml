name: Deploy Django Backend to Azure VM

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: PRD

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Build deploy archive
        run: |
          # Create a compressed archive from the committed HEAD (recommended)
          # This avoids 'tar: .: file changed as we read it' when files change while tar runs.
          git rev-parse --verify HEAD
          git archive --format=tar HEAD | gzip > deploy.tar.gz

          # If you need to include uncommitted files (not recommended for CI),
          # you can use a temporary clean copy and tar that instead:
          # tmpdir=$(mktemp -d)
          # rsync -a --exclude='.git' --exclude='.venv' --exclude='node_modules' . "$tmpdir/"
          # tar -C "$(dirname "$tmpdir")" -czf deploy.tar.gz "$(basename "$tmpdir")"
          # rm -rf "$tmpdir"

      - name: Remote healthcheck & create target dir
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.AZURE_VM_HOST }}
          username: ${{ secrets.AZURE_VM_USERNAME }}
          key: ${{ secrets.AZURE_VM_SSH_PRIVATE_KEY }}
          port: 22
          script: |
            echo "remote user: $(whoami)"
            echo "remote HOME: $HOME"
            mkdir -p "$HOME/money"
            ls -ld "$HOME" "$HOME/money"

      - name: Upload archive to VM
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.AZURE_VM_HOST }}
          username: ${{ secrets.AZURE_VM_USERNAME }}
          key: ${{ secrets.AZURE_VM_SSH_PRIVATE_KEY }}
          port: 22
          source: 'deploy.tar.gz'
          target: '/tmp'
          debug: true

      - name: Extract archive and run deploy script on VM
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.AZURE_VM_HOST }}
          username: ${{ secrets.AZURE_VM_USERNAME }}
          key: ${{ secrets.AZURE_VM_SSH_PRIVATE_KEY }}
          port: 22
          script: |
            set -euo pipefail
            echo "Preparing deploy directory..."
            rm -rf "$HOME/money"
            mkdir -p "$HOME/money"
            echo "Extracting archive to $HOME/money"
            tar xzf /tmp/deploy.tar.gz -C "$HOME/money"
            rm -f /tmp/deploy.tar.gz

            echo "Creating .env file..."
            printf '%s\n' "POSTGRES_DB=${{ secrets.POSTGRES_DB }}" > "$HOME/money/.env"
            printf '%s\n' "POSTGRES_USER=${{ secrets.POSTGRES_USER }}" >> "$HOME/money/.env"
            printf '%s\n' "POSTGRES_PASSWORD=${{ secrets.POSTGRES_PASSWORD }}" >> "$HOME/money/.env"
            printf '%s\n' "POSTGRES_HOST=${{ secrets.POSTGRES_HOST }}" >> "$HOME/money/.env"
            printf '%s\n' "POSTGRES_PORT=${{ secrets.POSTGRES_PORT }}" >> "$HOME/money/.env"
            printf '%s\n' "DJANGO_SUPERUSER_EMAIL=${{ secrets.DJANGO_SUPERUSER_EMAIL }}" >> "$HOME/money/.env"
            printf '%s\n' "DJANGO_SUPERUSER_PASSWORD=${{ secrets.DJANGO_SUPERUSER_PASSWORD }}" >> "$HOME/money/.env"
            printf '%s\n' "DJANGO_SUPERUSER_USERNAME=${{ secrets.DJANGO_SUPERUSER_USERNAME }}" >> "$HOME/money/.env"
            printf '%s\n' "DJANGO_SECRET_KEY=${{ secrets.DJANGO_SECRET_KEY }}" >> "$HOME/money/.env"
            printf '%s\n' "DJANGO_DEBUG=False" >> "$HOME/money/.env"
            printf '%s\n' "DJANGO_ALLOWED_HOSTS=${{ secrets.DJANGO_ALLOWED_HOSTS }}" >> "$HOME/money/.env"

            # Export variables for subsequent scripts
            set -a
            # shellcheck disable=SC1090
            source "$HOME/money/.env"
            set +a

            cd "$HOME/money"
            chmod +x ./config_django_env.sh
            ./config_django_env.sh
